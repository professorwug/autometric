# AUTOGENERATED! DO NOT EDIT! File to edit: ../nbs/0d1 Branching Datasets.ipynb.

# %% auto 0
__all__ = ['Stick', 'Branch']

# %% ../nbs/0d1 Branching Datasets.ipynb 3
from fastcore.all import *
from diffusion_curvature.random_surfaces import random_polynomial
import sympy as sp

class Stick():
    def __init__(
        self,
        dimension,
        degree,
        start_point,
        time_range = 1
    ):
        store_attr()
        # construct a unique polynomial for yourself
        x = sp.symbols('x')
        p = random_polynomial(
            [x],degree
        )
        self.polynomial = p
        self.polynomial_np = sp.lambdify([x], self.polynomial, "numpy")

        # random direction for polynomial
        self.direction = np.random.randn(self.dimension)

    def sample_at_time(self,t):
        return self.polynomial_np(self.direction*t)+ self.start_point

    def end_point(self):
        return self.sample_at_time(self.time_range)

    def sample(self, n_samples):
        ts = np.random.rand(n_samples)*self.time_range
        Xs = [self.sample_at_time(t) for t in ts]
        return np.array(Xs)

# %% ../nbs/0d1 Branching Datasets.ipynb 5
import random
import numpy as np
class Branch():
    def __init__(
        self,
        dimension,
        polynomial_degree=4,
        max_branches=5,
        path_length = 5,
        seed = None,
    ):
        store_attr()
        if seed is not None:
            torch.manual_seed(seed)
            np.random.seed(seed)
            random.seed(seed)

        self.sticks = [
            Stick(
                dimension,
                polynomial_degree,
                np.zeros(dimension)
            )
        ]
        self.branching_nums = [np.random.randint(1,max_branches)]
        stick_idx = 0
        for i in range(path_length):
            # go through all sticks after stick_idx and create new sticks at their ends
            new_stick_idx =len(self.sticks)
            for j in range(stick_idx,len(self.sticks)):
                num_new_sticks = self.branching_nums[j]
                for k in range(num_new_sticks):
                    # create a stick
                    stick = Stick(
                        dimension,
                        polynomial_degree,
                        self.sticks[j].end_point(),
                    )
                    self.sticks.append(stick)
                    self.branching_nums.append(
                        np.random.randint(1,max_branches)
                    )
            stick_idx = new_stick_idx
    def sample(self,n_samples=5000):
        Xs = []
        for stick in self.sticks:
            Xs.append(stick.sample(n_samples))
        return np.concatenate(Xs,axis=0)
